{
 "Description": "ToyApi monitoring and observability for dev environment",
 "Resources": {
  "AlertTopic2720D535": {
   "Type": "AWS::SNS::Topic",
   "Properties": {
    "DisplayName": "ToyApi DEV Alerts",
    "Tags": [
     {
      "Key": "CostCenter",
      "Value": "ToyApi-dev"
     },
     {
      "Key": "Environment",
      "Value": "dev"
     },
     {
      "Key": "Owner",
      "Value": "thismakesmehappy"
     },
     {
      "Key": "Project",
      "Value": "ToyApi"
     }
    ],
    "TopicName": "toyapi-dev-alerts"
   },
   "Metadata": {
    "aws:cdk:path": "ToyApiMonitoring-dev/AlertTopic/Resource"
   }
  },
  "AlertTopicadminthismakesmehappyco69ACD663": {
   "Type": "AWS::SNS::Subscription",
   "Properties": {
    "Endpoint": "admin@thismakesmehappy.co",
    "Protocol": "email",
    "TopicArn": {
     "Ref": "AlertTopic2720D535"
    }
   },
   "Metadata": {
    "aws:cdk:path": "ToyApiMonitoring-dev/AlertTopic/admin@thismakesmehappy.co/Resource"
   }
  },
  "MainDashboard5197298C": {
   "Type": "AWS::CloudWatch::Dashboard",
   "Properties": {
    "DashboardBody": {
     "Fn::Join": [
      "",
      [
       "{\"widgets\":[{\"type\":\"metric\",\"width\":12,\"height\":6,\"x\":0,\"y\":0,\"properties\":{\"view\":\"timeSeries\",\"title\":\"API Gateway - Request Volume\",\"region\":\"",
       {
        "Ref": "AWS::Region"
       },
       "\",\"metrics\":[[\"AWS/ApiGateway\",\"Count\",\"ApiName\",\"toyapi-dev-api\",{\"stat\":\"Sum\"}]],\"yAxis\":{}}},{\"type\":\"metric\",\"width\":12,\"height\":6,\"x\":12,\"y\":0,\"properties\":{\"view\":\"timeSeries\",\"title\":\"API Gateway - Latency\",\"region\":\"",
       {
        "Ref": "AWS::Region"
       },
       "\",\"metrics\":[[\"AWS/ApiGateway\",\"Latency\",\"ApiName\",\"toyapi-dev-api\"]],\"yAxis\":{}}},{\"type\":\"metric\",\"width\":12,\"height\":6,\"x\":0,\"y\":6,\"properties\":{\"view\":\"timeSeries\",\"title\":\"API Gateway - Errors\",\"region\":\"",
       {
        "Ref": "AWS::Region"
       },
       "\",\"metrics\":[[\"AWS/ApiGateway\",\"4XXError\",\"ApiName\",\"toyapi-dev-api\",{\"stat\":\"Sum\"}],[\"AWS/ApiGateway\",\"5XXError\",\"ApiName\",\"toyapi-dev-api\",{\"stat\":\"Sum\"}]],\"yAxis\":{}}},{\"type\":\"metric\",\"width\":24,\"height\":6,\"x\":0,\"y\":12,\"properties\":{\"view\":\"singleValue\",\"title\":\"Lambda Functions Status\",\"region\":\"",
       {
        "Ref": "AWS::Region"
       },
       "\",\"metrics\":[[\"AWS/Lambda\",\"Invocations\",\"FunctionName\",\"toyapi-dev-publicfunction\",{\"stat\":\"Sum\"}],[\"AWS/Lambda\",\"Invocations\",\"FunctionName\",\"toyapi-dev-authfunction\",{\"stat\":\"Sum\"}],[\"AWS/Lambda\",\"Invocations\",\"FunctionName\",\"toyapi-dev-itemsfunction\",{\"stat\":\"Sum\"}]]}},{\"type\":\"metric\",\"width\":12,\"height\":6,\"x\":0,\"y\":18,\"properties\":{\"view\":\"timeSeries\",\"title\":\"Application Error Tracking\",\"region\":\"",
       {
        "Ref": "AWS::Region"
       },
       "\",\"metrics\":[[\"ToyApi/DEV\",\"ApplicationErrors\",{\"stat\":\"Sum\"}]],\"yAxis\":{}}},{\"type\":\"metric\",\"width\":6,\"height\":6,\"x\":0,\"y\":24,\"properties\":{\"view\":\"singleValue\",\"title\":\"SLA Compliance\",\"region\":\"",
       {
        "Ref": "AWS::Region"
       },
       "\",\"metrics\":[[\"ToyApi/DEV\",\"SLA_Compliance\"]]}},{\"type\":\"metric\",\"width\":12,\"height\":6,\"x\":0,\"y\":30,\"properties\":{\"view\":\"timeSeries\",\"title\":\"Estimated Monthly Charges\",\"region\":\"",
       {
        "Ref": "AWS::Region"
       },
       "\",\"metrics\":[[\"AWS/Billing\",\"EstimatedCharges\",\"Currency\",\"USD\",{\"period\":21600,\"stat\":\"Maximum\"}]],\"yAxis\":{}}},{\"type\":\"metric\",\"width\":12,\"height\":6,\"x\":0,\"y\":36,\"properties\":{\"view\":\"timeSeries\",\"title\":\"Error Rate (5min intervals)\",\"region\":\"",
       {
        "Ref": "AWS::Region"
       },
       "\",\"metrics\":[[\"ToyApi/dev\",\"ErrorCount\",{\"stat\":\"Sum\"}]],\"yAxis\":{}}},{\"type\":\"metric\",\"width\":12,\"height\":6,\"x\":12,\"y\":36,\"properties\":{\"view\":\"timeSeries\",\"title\":\"API Key Usage (hourly)\",\"region\":\"",
       {
        "Ref": "AWS::Region"
       },
       "\",\"metrics\":[[\"ToyApi/dev\",\"ApiKeyRequests\",{\"period\":3600,\"stat\":\"Sum\"}]],\"yAxis\":{}}},{\"type\":\"metric\",\"width\":12,\"height\":6,\"x\":0,\"y\":42,\"properties\":{\"view\":\"timeSeries\",\"title\":\"Developer Registrations (6hr intervals)\",\"region\":\"",
       {
        "Ref": "AWS::Region"
       },
       "\",\"metrics\":[[\"ToyApi/dev\",\"DeveloperRegistrations\",{\"period\":21600,\"stat\":\"Sum\"}]],\"yAxis\":{}}}]}"
      ]
     ]
    },
    "DashboardName": "toyapi-dev-monitoring"
   },
   "Metadata": {
    "aws:cdk:path": "ToyApiMonitoring-dev/MainDashboard/Resource"
   }
  },
  "ApiHighLatencyAlarm4FCDEADA": {
   "Type": "AWS::CloudWatch::Alarm",
   "Properties": {
    "AlarmActions": [
     {
      "Ref": "AlertTopic2720D535"
     }
    ],
    "AlarmDescription": "API Gateway latency is too high",
    "AlarmName": "toyapi-dev-api-high-latency",
    "ComparisonOperator": "GreaterThanThreshold",
    "Dimensions": [
     {
      "Name": "ApiName",
      "Value": "toyapi-dev-api"
     }
    ],
    "EvaluationPeriods": 2,
    "MetricName": "Latency",
    "Namespace": "AWS/ApiGateway",
    "Period": 300,
    "Statistic": "Average",
    "Threshold": 2000
   },
   "Metadata": {
    "aws:cdk:path": "ToyApiMonitoring-dev/ApiHighLatencyAlarm/Resource"
   }
  },
  "ApiHighErrorRateAlarm9B5E12FA": {
   "Type": "AWS::CloudWatch::Alarm",
   "Properties": {
    "AlarmActions": [
     {
      "Ref": "AlertTopic2720D535"
     }
    ],
    "AlarmDescription": "API Gateway error rate is too high",
    "AlarmName": "toyapi-dev-api-high-error-rate",
    "ComparisonOperator": "GreaterThanThreshold",
    "Dimensions": [
     {
      "Name": "ApiName",
      "Value": "toyapi-dev-api"
     }
    ],
    "EvaluationPeriods": 2,
    "MetricName": "4XXError",
    "Namespace": "AWS/ApiGateway",
    "Period": 300,
    "Statistic": "Sum",
    "Threshold": 10
   },
   "Metadata": {
    "aws:cdk:path": "ToyApiMonitoring-dev/ApiHighErrorRateAlarm/Resource"
   }
  },
  "toyapidevpublicfunctionErrorAlarmEE876277": {
   "Type": "AWS::CloudWatch::Alarm",
   "Properties": {
    "AlarmActions": [
     {
      "Ref": "AlertTopic2720D535"
     }
    ],
    "AlarmDescription": "Lambda function toyapi-dev-publicfunction has errors",
    "AlarmName": "toyapi-dev-publicfunction-errors",
    "ComparisonOperator": "GreaterThanOrEqualToThreshold",
    "Dimensions": [
     {
      "Name": "FunctionName",
      "Value": "toyapi-dev-publicfunction"
     }
    ],
    "EvaluationPeriods": 1,
    "MetricName": "Errors",
    "Namespace": "AWS/Lambda",
    "Period": 300,
    "Statistic": "Sum",
    "Threshold": 5
   },
   "Metadata": {
    "aws:cdk:path": "ToyApiMonitoring-dev/toyapi-dev-publicfunction-ErrorAlarm/Resource"
   }
  },
  "toyapidevpublicfunctionThrottleAlarmFF160B4C": {
   "Type": "AWS::CloudWatch::Alarm",
   "Properties": {
    "AlarmActions": [
     {
      "Ref": "AlertTopic2720D535"
     }
    ],
    "AlarmDescription": "Lambda function toyapi-dev-publicfunction is being throttled",
    "AlarmName": "toyapi-dev-publicfunction-throttles",
    "ComparisonOperator": "GreaterThanOrEqualToThreshold",
    "Dimensions": [
     {
      "Name": "FunctionName",
      "Value": "toyapi-dev-publicfunction"
     }
    ],
    "EvaluationPeriods": 1,
    "MetricName": "Throttles",
    "Namespace": "AWS/Lambda",
    "Period": 300,
    "Statistic": "Sum",
    "Threshold": 1
   },
   "Metadata": {
    "aws:cdk:path": "ToyApiMonitoring-dev/toyapi-dev-publicfunction-ThrottleAlarm/Resource"
   }
  },
  "toyapidevauthfunctionErrorAlarm8A8DED49": {
   "Type": "AWS::CloudWatch::Alarm",
   "Properties": {
    "AlarmActions": [
     {
      "Ref": "AlertTopic2720D535"
     }
    ],
    "AlarmDescription": "Lambda function toyapi-dev-authfunction has errors",
    "AlarmName": "toyapi-dev-authfunction-errors",
    "ComparisonOperator": "GreaterThanOrEqualToThreshold",
    "Dimensions": [
     {
      "Name": "FunctionName",
      "Value": "toyapi-dev-authfunction"
     }
    ],
    "EvaluationPeriods": 1,
    "MetricName": "Errors",
    "Namespace": "AWS/Lambda",
    "Period": 300,
    "Statistic": "Sum",
    "Threshold": 5
   },
   "Metadata": {
    "aws:cdk:path": "ToyApiMonitoring-dev/toyapi-dev-authfunction-ErrorAlarm/Resource"
   }
  },
  "toyapidevauthfunctionThrottleAlarmA5B641BC": {
   "Type": "AWS::CloudWatch::Alarm",
   "Properties": {
    "AlarmActions": [
     {
      "Ref": "AlertTopic2720D535"
     }
    ],
    "AlarmDescription": "Lambda function toyapi-dev-authfunction is being throttled",
    "AlarmName": "toyapi-dev-authfunction-throttles",
    "ComparisonOperator": "GreaterThanOrEqualToThreshold",
    "Dimensions": [
     {
      "Name": "FunctionName",
      "Value": "toyapi-dev-authfunction"
     }
    ],
    "EvaluationPeriods": 1,
    "MetricName": "Throttles",
    "Namespace": "AWS/Lambda",
    "Period": 300,
    "Statistic": "Sum",
    "Threshold": 1
   },
   "Metadata": {
    "aws:cdk:path": "ToyApiMonitoring-dev/toyapi-dev-authfunction-ThrottleAlarm/Resource"
   }
  },
  "toyapidevitemsfunctionErrorAlarm306F606E": {
   "Type": "AWS::CloudWatch::Alarm",
   "Properties": {
    "AlarmActions": [
     {
      "Ref": "AlertTopic2720D535"
     }
    ],
    "AlarmDescription": "Lambda function toyapi-dev-itemsfunction has errors",
    "AlarmName": "toyapi-dev-itemsfunction-errors",
    "ComparisonOperator": "GreaterThanOrEqualToThreshold",
    "Dimensions": [
     {
      "Name": "FunctionName",
      "Value": "toyapi-dev-itemsfunction"
     }
    ],
    "EvaluationPeriods": 1,
    "MetricName": "Errors",
    "Namespace": "AWS/Lambda",
    "Period": 300,
    "Statistic": "Sum",
    "Threshold": 5
   },
   "Metadata": {
    "aws:cdk:path": "ToyApiMonitoring-dev/toyapi-dev-itemsfunction-ErrorAlarm/Resource"
   }
  },
  "toyapidevitemsfunctionThrottleAlarm8050D44C": {
   "Type": "AWS::CloudWatch::Alarm",
   "Properties": {
    "AlarmActions": [
     {
      "Ref": "AlertTopic2720D535"
     }
    ],
    "AlarmDescription": "Lambda function toyapi-dev-itemsfunction is being throttled",
    "AlarmName": "toyapi-dev-itemsfunction-throttles",
    "ComparisonOperator": "GreaterThanOrEqualToThreshold",
    "Dimensions": [
     {
      "Name": "FunctionName",
      "Value": "toyapi-dev-itemsfunction"
     }
    ],
    "EvaluationPeriods": 1,
    "MetricName": "Throttles",
    "Namespace": "AWS/Lambda",
    "Period": 300,
    "Statistic": "Sum",
    "Threshold": 1
   },
   "Metadata": {
    "aws:cdk:path": "ToyApiMonitoring-dev/toyapi-dev-itemsfunction-ThrottleAlarm/Resource"
   }
  },
  "ApplicationErrorAlarm3C0D912E": {
   "Type": "AWS::CloudWatch::Alarm",
   "Properties": {
    "AlarmActions": [
     {
      "Ref": "AlertTopic2720D535"
     }
    ],
    "AlarmDescription": "Application is experiencing high error rates",
    "AlarmName": "toyapi-dev-application-errors",
    "ComparisonOperator": "GreaterThanThreshold",
    "EvaluationPeriods": 2,
    "MetricName": "ApplicationErrors",
    "Namespace": "ToyApi/DEV",
    "Period": 300,
    "Statistic": "Sum",
    "Threshold": 10,
    "TreatMissingData": "notBreaching"
   },
   "Metadata": {
    "aws:cdk:path": "ToyApiMonitoring-dev/ApplicationErrorAlarm/Resource"
   }
  },
  "SLABreachAlarmB9AB53EF": {
   "Type": "AWS::CloudWatch::Alarm",
   "Properties": {
    "AlarmActions": [
     {
      "Ref": "AlertTopic2720D535"
     }
    ],
    "AlarmDescription": "SLA compliance is below threshold",
    "AlarmName": "toyapi-dev-sla-breach",
    "ComparisonOperator": "LessThanThreshold",
    "EvaluationPeriods": 3,
    "MetricName": "SLA_Compliance",
    "Namespace": "ToyApi/DEV",
    "Period": 300,
    "Statistic": "Average",
    "Threshold": 0.95,
    "TreatMissingData": "breaching"
   },
   "Metadata": {
    "aws:cdk:path": "ToyApiMonitoring-dev/SLABreachAlarm/Resource"
   }
  },
  "CostAlarm97D2533C": {
   "Type": "AWS::CloudWatch::Alarm",
   "Properties": {
    "AlarmActions": [
     {
      "Ref": "AlertTopic2720D535"
     }
    ],
    "AlarmDescription": "Monthly costs approaching budget limit",
    "AlarmName": "toyapi-dev-cost-alert",
    "ComparisonOperator": "GreaterThanThreshold",
    "Dimensions": [
     {
      "Name": "Currency",
      "Value": "USD"
     }
    ],
    "EvaluationPeriods": 1,
    "MetricName": "EstimatedCharges",
    "Namespace": "AWS/Billing",
    "Period": 21600,
    "Statistic": "Maximum",
    "Threshold": 8
   },
   "Metadata": {
    "aws:cdk:path": "ToyApiMonitoring-dev/CostAlarm/Resource"
   }
  },
  "CentralLogGroup33AD0CAD": {
   "Type": "AWS::Logs::LogGroup",
   "Properties": {
    "LogGroupName": "/aws/apigateway/toyapi-dev-aggregated",
    "RetentionInDays": 30,
    "Tags": [
     {
      "Key": "CostCenter",
      "Value": "ToyApi-dev"
     },
     {
      "Key": "Environment",
      "Value": "dev"
     },
     {
      "Key": "Owner",
      "Value": "thismakesmehappy"
     },
     {
      "Key": "Project",
      "Value": "ToyApi"
     }
    ]
   },
   "UpdateReplacePolicy": "Delete",
   "DeletionPolicy": "Delete",
   "Metadata": {
    "aws:cdk:path": "ToyApiMonitoring-dev/CentralLogGroup/Resource"
   }
  },
  "ErrorMetricFilter77F7AAD4": {
   "Type": "AWS::Logs::MetricFilter",
   "Properties": {
    "FilterPattern": "?\"ERROR\" ?\"4[0-9][0-9]\" ?\"5[0-9][0-9]\" ?\"Exception\" ?\"Failed\"",
    "LogGroupName": {
     "Ref": "CentralLogGroup33AD0CAD"
    },
    "MetricTransformations": [
     {
      "DefaultValue": 0,
      "MetricName": "ErrorCount",
      "MetricNamespace": "ToyApi/dev",
      "MetricValue": "1"
     }
    ]
   },
   "Metadata": {
    "aws:cdk:path": "ToyApiMonitoring-dev/ErrorMetricFilter/Resource"
   }
  },
  "ApiKeyUsageFilterF529FBB0": {
   "Type": "AWS::Logs::MetricFilter",
   "Properties": {
    "FilterPattern": "{ $.apiKeyId = \"*\" }",
    "LogGroupName": {
     "Ref": "CentralLogGroup33AD0CAD"
    },
    "MetricTransformations": [
     {
      "DefaultValue": 0,
      "MetricName": "ApiKeyRequests",
      "MetricNamespace": "ToyApi/dev",
      "MetricValue": "1"
     }
    ]
   },
   "Metadata": {
    "aws:cdk:path": "ToyApiMonitoring-dev/ApiKeyUsageFilter/Resource"
   }
  },
  "SlowRequestFilter586BA7BA": {
   "Type": "AWS::Logs::MetricFilter",
   "Properties": {
    "FilterPattern": "[timestamp, requestId, responseTime > 1000]",
    "LogGroupName": {
     "Ref": "CentralLogGroup33AD0CAD"
    },
    "MetricTransformations": [
     {
      "DefaultValue": 0,
      "MetricName": "SlowRequests",
      "MetricNamespace": "ToyApi/dev",
      "MetricValue": "1"
     }
    ]
   },
   "Metadata": {
    "aws:cdk:path": "ToyApiMonitoring-dev/SlowRequestFilter/Resource"
   }
  },
  "DeveloperRegistrationFilter2C51F60B": {
   "Type": "AWS::Logs::MetricFilter",
   "Properties": {
    "FilterPattern": "[timestamp, requestId, \"Developer registered successfully\"]",
    "LogGroupName": {
     "Ref": "CentralLogGroup33AD0CAD"
    },
    "MetricTransformations": [
     {
      "DefaultValue": 0,
      "MetricName": "DeveloperRegistrations",
      "MetricNamespace": "ToyApi/dev",
      "MetricValue": "1"
     }
    ]
   },
   "Metadata": {
    "aws:cdk:path": "ToyApiMonitoring-dev/DeveloperRegistrationFilter/Resource"
   }
  },
  "LogErrorRateAlarm9E40A0A2": {
   "Type": "AWS::CloudWatch::Alarm",
   "Properties": {
    "AlarmActions": [
     {
      "Ref": "AlertTopic2720D535"
     }
    ],
    "AlarmDescription": "High error rate detected in API logs",
    "AlarmName": "toyapi-dev-log-error-rate",
    "ComparisonOperator": "GreaterThanThreshold",
    "EvaluationPeriods": 2,
    "MetricName": "ErrorCount",
    "Namespace": "ToyApi/dev",
    "Period": 300,
    "Statistic": "Sum",
    "Threshold": 10,
    "TreatMissingData": "notBreaching"
   },
   "Metadata": {
    "aws:cdk:path": "ToyApiMonitoring-dev/LogErrorRateAlarm/Resource"
   }
  },
  "SlowRequestAlarm23598036": {
   "Type": "AWS::CloudWatch::Alarm",
   "Properties": {
    "AlarmActions": [
     {
      "Ref": "AlertTopic2720D535"
     }
    ],
    "AlarmDescription": "High number of slow requests detected",
    "AlarmName": "toyapi-dev-slow-requests",
    "ComparisonOperator": "GreaterThanThreshold",
    "EvaluationPeriods": 1,
    "MetricName": "SlowRequests",
    "Namespace": "ToyApi/dev",
    "Period": 600,
    "Statistic": "Sum",
    "Threshold": 5,
    "TreatMissingData": "notBreaching"
   },
   "Metadata": {
    "aws:cdk:path": "ToyApiMonitoring-dev/SlowRequestAlarm/Resource"
   }
  },
  "CDKMetadata": {
   "Type": "AWS::CDK::Metadata",
   "Properties": {
    "Analytics": "v2:deflate64:H4sIAAAAAAAA/02Nyw6CMBBFv4V9qUDcuDQaTYzGBNybMlQYKW3ThyxI/10qibqac8+9yRR0k9MsYaNNoelTgTWdKsegJ7O6T1ZaOt2URiC7h1yg8rUFg9qhktH+50BAKN+MzEFHpz2zXa2YaeLsF7aCmSGqDwQiVDt/Oav2aJTXsfjyhTuDcEDhuInFfw4hmqt32rtIJbfKG+CBnNiLrYo1zWiePC1iarx0OHBaLvcNA+w7kPUAAAA="
   },
   "Metadata": {
    "aws:cdk:path": "ToyApiMonitoring-dev/CDKMetadata/Default"
   }
  }
 },
 "Outputs": {
  "DashboardUrl": {
   "Description": "CloudWatch Dashboard URL",
   "Value": {
    "Fn::Join": [
     "",
     [
      "https://console.aws.amazon.com/cloudwatch/home?region=us-east-1#dashboards:name=",
      {
       "Ref": "MainDashboard5197298C"
      }
     ]
    ]
   }
  },
  "AlertTopicArn": {
   "Description": "SNS Topic ARN for monitoring alerts",
   "Value": {
    "Ref": "AlertTopic2720D535"
   }
  }
 },
 "Parameters": {
  "BootstrapVersion": {
   "Type": "AWS::SSM::Parameter::Value<String>",
   "Default": "/cdk-bootstrap/hnb659fds/version",
   "Description": "Version of the CDK Bootstrap resources in this environment, automatically retrieved from SSM Parameter Store. [cdk:skip]"
  }
 },
 "Rules": {
  "CheckBootstrapVersion": {
   "Assertions": [
    {
     "Assert": {
      "Fn::Not": [
       {
        "Fn::Contains": [
         [
          "1",
          "2",
          "3",
          "4",
          "5"
         ],
         {
          "Ref": "BootstrapVersion"
         }
        ]
       }
      ]
     },
     "AssertDescription": "CDK bootstrap stack version 6 required. Please run 'cdk bootstrap' with a recent version of the CDK CLI."
    }
   ]
  }
 }
}